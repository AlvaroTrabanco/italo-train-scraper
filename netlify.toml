[build]
  command = "pip3 install -r scraper/requirements.txt && SERVICE_DATE=$(date -u -d 'tomorrow' +%Y%m%d) && mkdir -p out normalized normalized_latest gtfs public/gtfs public/reports public/state && python3 scraper/italo_scrape.py --trains-file scraper/trains.txt --outdir out --slice-size 999999 --slice-index 0 --skip-empty && RUN_UTC=$(find out -maxdepth 1 -type d -name '20*T*Z' -printf '%f\n' | sort | tail -n 1) && python3 scraper/normalize_italo.py --input-dir out/$RUN_UTC --output-dir normalized/$RUN_UTC && cp -f normalized/$RUN_UTC/*.normalized.json normalized_latest/ 2>/dev/null || true && python3 scraper/build_gtfs.py --normalized-dir normalized_latest --service-date $SERVICE_DATE --out-zip gtfs/italo_$SERVICE_DATE.zip && cp gtfs/italo_$SERVICE_DATE.zip public/gtfs/italo_latest.zip && cp gtfs/italo_$SERVICE_DATE.zip public/gtfs/italo_$SERVICE_DATE.zip && python3 scraper/report_missing_routes.py --expected-csv expected_routes_mapped.csv --gtfs-zip gtfs/italo_$SERVICE_DATE.zip --out-dir public/reports --out-prefix missing_routes && python3 scraper/report_stops.py --normalized-dir normalized_latest --coordinates coordinates.csv --out-dir public/reports --run-utc $RUN_UTC --inventory-out public/reports/stop_inventory.json --window-hours 192 && echo '<h1>Italo GTFS Export</h1><ul><li><a href=\"/gtfs/italo_latest.zip\">italo_latest.zip</a></li><li><a href=\"/reports/missing_routes_latest.md\">missing_routes_latest.md</a></li><li><a href=\"/reports/stops_report_latest.md\">stops_report_latest.md</a></li></ul>' > public/index.html"
  publish = "public"
