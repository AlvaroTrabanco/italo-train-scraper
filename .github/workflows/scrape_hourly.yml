name: Italo hourly scrape (1 week)

on:
  workflow_dispatch:
  schedule:
    - cron: "0 * * * *"  # every hour

jobs:
  scrape:
    runs-on: ubuntu-latest
    env:
      # Set this to (now + 7 days) in UTC, format: YYYY-MM-DDTHH:MM:SSZ
      END_UTC: "2026-02-26T00:00:00Z"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Stop after END_UTC
        shell: bash
        run: |
          NOW="$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          echo "NOW=$NOW"
          echo "END_UTC=${END_UTC}"
          if [[ "$NOW" > "${END_UTC}" ]]; then
            echo "Past END_UTC; exiting without scraping."
            exit 0
          fi

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r scraper/requirements.txt

      - name: Run scraper (slice for this hour)
        shell: bash
        run: |
          # Use current UTC hour to pick a slice index (wraps automatically)
          SLICE_INDEX=$(date -u +%H)
          echo "SLICE_INDEX=$SLICE_INDEX"
          python scraper/italo_scrape.py \
            --range-start 0 \
            --range-end 9999 \
            --slice-size 500 \
            --slice-index "$SLICE_INDEX" \
            --outdir out \
            --timeout 25 \
            --retries 2 \
            --skip-empty \
            --sleep 0.15 --jitter 0.20

      - name: Upload artifact (this run)
        uses: actions/upload-artifact@v4
        with:
          name: italo-json-${{ github.run_id }}-${{ github.run_attempt }}
          path: out/
          retention-days: 8