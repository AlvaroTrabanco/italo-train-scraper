name: Italo hourly scrape (1 week)

on:
  workflow_dispatch:
  schedule:
    - cron: "0 * * * *"  # every hour

jobs:
  scrape:
    runs-on: ubuntu-latest
    env:
      # Set this to (now + 7 days) in UTC, format: YYYY-MM-DDTHH:MM:SSZ
      END_UTC: "2026-02-26T00:00:00Z"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Stop after END_UTC
        shell: bash
        run: |
          NOW="$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          echo "NOW=$NOW"
          echo "END_UTC=${END_UTC}"
          if [[ "$NOW" > "${END_UTC}" ]]; then
            echo "Past END_UTC; exiting without scraping."
            exit 0
          fi

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r scraper/requirements.txt

      - name: Run scraper (from trains.txt)
        shell: bash
        run: |
          # Rotate slices hourly over the trains.txt list
          SLICE_INDEX=$(date -u +%H)
          SLICE_SIZE=200

          python scraper/italo_scrape.py \
            --trains-file scraper/trains.txt \
            --slice-size "$SLICE_SIZE" \
            --slice-index "$SLICE_INDEX" \
            --outdir out \
            --timeout 25 \
            --retries 2 \
            --skip-empty \
            --sleep 0.15 --jitter 0.20

      - name: Normalize raw JSON to schedule JSON
        shell: bash
        run: |
          RUN_DIR=$(ls -1 out | tail -n 1)
          echo "Latest run dir: $RUN_DIR"
          mkdir -p normalized/$RUN_DIR
          python scraper/normalize_italo.py --input-dir "out/$RUN_DIR" --output-dir "normalized/$RUN_DIR"

      - name: Upload artifact (raw + normalized)
        uses: actions/upload-artifact@v4
        with:
          name: italo-${{ github.run_id }}-${{ github.run_attempt }}
          path: |
            out/
            normalized/
          retention-days: 8